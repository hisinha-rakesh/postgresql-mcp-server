# Enterprise PostgreSQL MCP Server

This is a comprehensive Model Context Protocol (MCP) server for PostgreSQL that provides full database management capabilities including DDL, DML, TCL operations, and advanced features like backup/restore and multiple authentication methods.

## Features

- **Full SQL Support**: DDL (CREATE, ALTER, DROP), DML (SELECT, INSERT, UPDATE, DELETE), and TCL (transactions)
- **Multiple Authentication Methods**:
  - Traditional PostgreSQL username/password authentication
  - EntraID (Azure AD) token-based authentication with automatic token refresh
- **Database Management**: Create, drop, and list databases
- **Schema Inspection**: Get detailed schema and table information
- **Backup & Restore**: SQL-based and pg_dump/pg_restore support
- **Transaction Support**: Execute multiple statements atomically
- **Azure PostgreSQL Support**: Full support for Azure PostgreSQL Flexible Server

---

## ðŸ›‘ Security Warning: VERY IMPORTANT ðŸ›‘

This application is a proof-of-concept and demonstrates a powerful capability. However, **executing arbitrary SQL generated by a Large Language Model (LLM) on a database is extremely dangerous.**

A malicious or poorly phrased natural language query could be translated into a destructive SQL command (e.g., `UPDATE users SET password = ''`), leading to data corruption, data loss, or security vulnerabilities.

**DO NOT run this in a production environment without significant modifications.**

### Recommended Safeguards:
1.  **Human-in-the-Loop:** Before executing any SQL, present it to a human for approval.
2.  **Least Privilege Principle:** Connect to the database with a user that has the absolute minimum required permissions. For this script, the user only needs `SELECT` permissions on `pg_catalog` tables (for schema introspection) and `UPDATE` permissions on the specific target tables. **It should NOT have `INSERT`, `DELETE`, `DROP`, `ALTER`, etc.**
3.  **Sandboxing:** Run this service in a containerized, isolated environment with restricted network access.
4.  **Transaction Validation:** Add more robust parsing and validation to ensure the generated SQL is safe and only targets expected tables and columns.

---

## 1. Setup

### Prerequisites
- Python 3.8+
- A running PostgreSQL database
- (Optional) Azure AD / EntraID for token-based authentication

### Installation
1.  **Clone/Download Files:** Make sure `mcp_postgres_server.py`, `mcp_client.py`, `requirements.txt`, and this `README.md` are in the same directory.

2.  **Create Virtual Environment:**
    ```bash
    python -m venv .venv
    ```

3.  **Activate Virtual Environment:**
    - On Windows:
      ```bash
      .venv\Scripts\activate
      ```
    - On Linux/Mac:
      ```bash
      source .venv/bin/activate
      ```

4.  **Install Dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

5.  **Environment Variables:**
    Create a file named `.env` in the same directory (you can copy from `.env.example`):

    #### For Traditional PostgreSQL Authentication:
    ```ini
    # .env file
    AUTH_TYPE=postgresql
    DATABASE_URL=postgresql://user:password@host:port/database?sslmode=require
    ```

    #### For EntraID (Azure AD) Authentication:
    ```ini
    # .env file
    AUTH_TYPE=entraid
    PG_HOST=myserver.postgres.database.azure.com
    PG_PORT=5432
    PG_DATABASE=mydatabase
    PG_USER=myapp
    PG_SSLMODE=require

    # For Service Principal (optional):
    AZURE_TENANT_ID=your-tenant-id
    AZURE_CLIENT_ID=your-client-id
    AZURE_CLIENT_SECRET=your-client-secret
    ```

---

## 2. Authentication Methods

### Traditional PostgreSQL Authentication

The standard method using username and password:
- Simple setup
- Works with any PostgreSQL server
- Credentials in DATABASE_URL

### EntraID (Azure AD) Authentication

Recommended for Azure PostgreSQL for enhanced security:
- No passwords stored - uses Azure AD tokens
- Automatic token refresh
- Supports multiple credential types:
  - **Managed Identity** (recommended for Azure resources)
  - **Service Principal** (for applications)
  - **Azure CLI** (for local development)
  - **Visual Studio Code** (for local development)

See [CONFIGURATION_GUIDE.md](CONFIGURATION_GUIDE.md) for detailed setup instructions.

## 3. Running the Server

### As an MCP Server (Recommended)

Configure the server in Claude Desktop or Claude Code. See [CONFIGURATION_GUIDE.md](CONFIGURATION_GUIDE.md) for details.

### Standalone Testing

You can also test the server directly:

```bash
cd C:\Users\kusha\postgresql-mcp
.venv\Scripts\activate
python server.py
```

The server will log the authentication method being used and connection status.

---

## 4. Available Tools

The MCP server provides 20 tools for database operations:

### Data Manipulation (DML)
- `execute_select` - Query data
- `execute_insert` - Insert rows
- `execute_update` - Update rows
- `execute_delete` - Delete rows

### Data Definition (DDL)
- `execute_create_table` - Create tables
- `execute_alter_table` - Modify table structure
- `execute_drop_table` - Delete tables
- `execute_create_index` - Create indexes
- `execute_drop_index` - Remove indexes

### Database Management
- `create_database` - Create new databases
- `drop_database` - Delete databases
- `list_databases` - List all databases

### Schema Inspection
- `get_schema_info` - Get database schema details
- `get_table_info` - Get table structure and statistics

### Backup & Restore
- `backup_database` - Create database backups
- `restore_database` - Restore from backups
- `list_backups` - List available backup files
- `check_backup_tools` - Check pg_dump/pg_restore availability

### Transactions
- `execute_transaction` - Execute multiple statements atomically

### Utilities
- `execute_raw_sql` - Execute any SQL statement
- `get_authentication_info` - View authentication configuration

## 5. Usage Examples

Once configured with Claude Desktop or Claude Code, you can interact naturally:

```
Can you show me the current authentication method?
```

```
List all databases on the server
```

```
Create a backup of the production database to C:\backups
```

```
Show me all tables in the public schema
```

```
Execute this query: SELECT * FROM users WHERE created_at > NOW() - INTERVAL '7 days'
```

### Using cURL

Let's assume you have a table named `employees` with columns `id` (integer), `name` (varchar), and `role` (varchar).

You can use `curl` to send a request:

```bash
curl -X POST "http://127.0.0.1:8000/mcp/update_table" \
     -H "Content-Type: application/json" \
     -d "{\"query\": \"In the employees table, change the role to Senior Developer for the person with an id of 10\"}"
```

### Expected Response
-   **Success (Status 200):**
    ```json
    {
      "message": "Update executed successfully.",
      "generated_sql": "UPDATE employees SET role = 'Senior Developer' WHERE id = 10"
    }
    ```
-   **Error (e.g., Status 400 or 500):**
    ```json
    {
      "detail": "Error message here..."
    }
    ```

---

## 4. Project Structure

```
postgresql-mcp/
â”œâ”€â”€ .env.example          # Example environment configuration
â”œâ”€â”€ .venv/                # Virtual environment (created during setup)
â”œâ”€â”€ mcp_postgres_server.py # FastAPI server with Claude integration
â”œâ”€â”€ mcp_client.py         # Python client for testing the server
â”œâ”€â”€ requirements.txt      # Python dependencies
â””â”€â”€ README.md            # This file
```

## 5. How It Works

1.  **Receive Query:** The server receives the natural language query.
2.  **Fetch Schema:** It connects to the database and inspects its schema (tables, columns, and types).
3.  **Generate SQL:** It sends a carefully crafted prompt to Claude (via Azure OpenAI). The prompt includes the user's query and the database schema, instructing the model to generate a single, precise SQL `UPDATE` statement.
4.  **Validate SQL:** The server performs a basic check to ensure the generated command is an `UPDATE` statement.
5.  **Execute SQL:** If validation passes, the server executes the SQL statement within a transaction. The transaction is rolled back if any error occurs.
6.  **Return Response:** It returns a success or error message.

## 6. API Endpoints

- `GET /` - Health check endpoint
- `POST /mcp/update_table` - Execute natural language update query

## 7. Dependencies

- **fastapi** - Web framework
- **uvicorn** - ASGI server
- **httpx** - HTTP client for Azure API calls
- **sqlalchemy** - Database ORM
- **psycopg2** or **asyncpg** - PostgreSQL driver
- **python-dotenv** - Environment variable management
- **pydantic** - Data validation
- **requests** - HTTP library for the client