# MCP-style FastAPI Server for PostgreSQL Updates via Natural Language

This project provides a FastAPI server that acts as a simple MCP-style endpoint to interact with a PostgreSQL database. It exposes an API that accepts natural language queries, translates them into SQL `UPDATE` statements using Claude (via Azure OpenAI), and executes them against the database.

---

## ðŸ›‘ Security Warning: VERY IMPORTANT ðŸ›‘

This application is a proof-of-concept and demonstrates a powerful capability. However, **executing arbitrary SQL generated by a Large Language Model (LLM) on a database is extremely dangerous.**

A malicious or poorly phrased natural language query could be translated into a destructive SQL command (e.g., `UPDATE users SET password = ''`), leading to data corruption, data loss, or security vulnerabilities.

**DO NOT run this in a production environment without significant modifications.**

### Recommended Safeguards:
1.  **Human-in-the-Loop:** Before executing any SQL, present it to a human for approval.
2.  **Least Privilege Principle:** Connect to the database with a user that has the absolute minimum required permissions. For this script, the user only needs `SELECT` permissions on `pg_catalog` tables (for schema introspection) and `UPDATE` permissions on the specific target tables. **It should NOT have `INSERT`, `DELETE`, `DROP`, `ALTER`, etc.**
3.  **Sandboxing:** Run this service in a containerized, isolated environment with restricted network access.
4.  **Transaction Validation:** Add more robust parsing and validation to ensure the generated SQL is safe and only targets expected tables and columns.

---

## 1. Setup

### Prerequisites
- Python 3.8+
- A running PostgreSQL database
- Azure OpenAI account with Claude deployment

### Installation
1.  **Clone/Download Files:** Make sure `mcp_postgres_server.py`, `mcp_client.py`, `requirements.txt`, and this `README.md` are in the same directory.

2.  **Create Virtual Environment:**
    ```bash
    python -m venv .venv
    ```

3.  **Activate Virtual Environment:**
    - On Windows:
      ```bash
      .venv\Scripts\activate
      ```
    - On Linux/Mac:
      ```bash
      source .venv/bin/activate
      ```

4.  **Install Dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

5.  **Environment Variables:**
    Create a file named `.env` in the same directory (you can copy from `.env.example`):

    ```
    # .env file
    # PostgreSQL Database URL
    DATABASE_URL=postgresql://user:password@host:port/database?sslmode=require

    # Azure Claude Configuration
    AZURE_API_KEY=your_azure_api_key_here
    AZURE_ENDPOINT=https://your-endpoint.services.ai.azure.com/anthropic/
    DEPLOYMENT_NAME=claude-sonnet-4-5-2
    ```

---

## 2. Running the Server

Once the setup is complete, you can start the FastAPI server using Uvicorn:

```bash
python mcp_postgres_server.py
```

Or alternatively:

```bash
uvicorn mcp_postgres_server:app --reload --host 127.0.0.1 --port 8000
```

The server will be running at `http://127.0.0.1:8000`.

---

## 3. Usage

You can send `POST` requests to the `/mcp/update_table` endpoint with a JSON payload containing your natural language query.

### Using the Python Client

The easiest way to interact with the server is using the provided `mcp_client.py`:

```bash
python mcp_client.py
```

This will run the example queries defined in the client script.

### Using cURL

Let's assume you have a table named `employees` with columns `id` (integer), `name` (varchar), and `role` (varchar).

You can use `curl` to send a request:

```bash
curl -X POST "http://127.0.0.1:8000/mcp/update_table" \
     -H "Content-Type: application/json" \
     -d "{\"query\": \"In the employees table, change the role to Senior Developer for the person with an id of 10\"}"
```

### Expected Response
-   **Success (Status 200):**
    ```json
    {
      "message": "Update executed successfully.",
      "generated_sql": "UPDATE employees SET role = 'Senior Developer' WHERE id = 10"
    }
    ```
-   **Error (e.g., Status 400 or 500):**
    ```json
    {
      "detail": "Error message here..."
    }
    ```

---

## 4. Project Structure

```
postgresql-mcp/
â”œâ”€â”€ .env.example          # Example environment configuration
â”œâ”€â”€ .venv/                # Virtual environment (created during setup)
â”œâ”€â”€ mcp_postgres_server.py # FastAPI server with Claude integration
â”œâ”€â”€ mcp_client.py         # Python client for testing the server
â”œâ”€â”€ requirements.txt      # Python dependencies
â””â”€â”€ README.md            # This file
```

## 5. How It Works

1.  **Receive Query:** The server receives the natural language query.
2.  **Fetch Schema:** It connects to the database and inspects its schema (tables, columns, and types).
3.  **Generate SQL:** It sends a carefully crafted prompt to Claude (via Azure OpenAI). The prompt includes the user's query and the database schema, instructing the model to generate a single, precise SQL `UPDATE` statement.
4.  **Validate SQL:** The server performs a basic check to ensure the generated command is an `UPDATE` statement.
5.  **Execute SQL:** If validation passes, the server executes the SQL statement within a transaction. The transaction is rolled back if any error occurs.
6.  **Return Response:** It returns a success or error message.

## 6. API Endpoints

- `GET /` - Health check endpoint
- `POST /mcp/update_table` - Execute natural language update query

## 7. Dependencies

- **fastapi** - Web framework
- **uvicorn** - ASGI server
- **httpx** - HTTP client for Azure API calls
- **sqlalchemy** - Database ORM
- **psycopg2** or **asyncpg** - PostgreSQL driver
- **python-dotenv** - Environment variable management
- **pydantic** - Data validation
- **requests** - HTTP library for the client